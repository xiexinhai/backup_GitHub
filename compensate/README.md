# Compensation system

**The macros are used to compensate the magnetic field**

Current status: This macro still need improvement.

Current setup: Put a B-field sensor outside of the chamber, one of the track. Assume the B-field difference between the outside sensor and the chamber sentor is the same value, this macro can have a simple compensation to the centor B-field.
**The setup need to be modified under different situations**.

One can run the macro by:
`python control.py`

**Main part of the macro:**
- Definition for time interval, ADC channel, constant B-field (**Need to be modified to the real situation!**):
```
deltaT = 1

chVx = 0
chVy = 1
chVz = 2

T1ch = 3
T2ch = 4

const_Bout = np.mat([0,0,0]).T
const_Bcen = np.mat([0,0,0]).T
```
Under simple situation, `const_Bout - const_Bcen ` can be assumed as constant. Waiting future improvement from B-field mapping.

- Definition of the matrix related to three coils:

**Need to be modified to the real situation!**

**Pay attention on the values when inversely connect the power suplies with the coils!**
```
#definition of the matrix related to three coils, determined by the position of the outside sensor
OutBx  = 0.853237108
OutBxy = -0.717304637
OutBxz = -0.010788633

OutByx = -0.242167464
OutBy  = 0.978787453
OutByz = -0.047495391

OutBzx = 0.007704043
OutBzy = 0.094762699
OutBz  = -0.381223172

matOut = 100*np.mat([[OutBx,OutByx,OutBzx],[OutBxy,OutBy,OutBzy],[OutBxz,OutByz,OutBz]])
invmatOut = np.linalg.inv(matOut)

#definition of the matrix related to three coils, determined by the position of the center (the conpensate position)
CenBx  = 0.6335030219254629
CenBxy = 0
CenBxz = 0

CenByx = 0
CenBy  = 0.6585812023055216
CenByz = 0

CenBzx = 0
CenBzy = 0
CenBz  = -0.6530124174708793

matCen = 100*np.mat([[CenBx,CenByx,CenBzx],[CenBxy,CenBy,CenBzy],[CenBxz,CenByz,CenBz]])
invmatCen = np.linalg.inv(matCen)

```
The matrix corresponds to the coils. Currently can be calculated using macros in **cal_magnetic**. Can be improved. The meaning of the element in the matrix, for examples:

`OutBx x 100` is the B-field value ($\mu$T)  on x-axis at the position of the outside sensor generated by the Left-Right coil when applying current `I=1A`.

`CenBy x 100` is the B-field value ($\mu$T)  on y-axis at the position of the chamber center generated by the Up-down coil when applying current `I=1A`.

`CenBz x 100` is the B-field value ($\mu$T)  on z-axis at the position of the chamber center generated by the Forwar-backward coil when applying current `I=1A`.

`OutBzy x 100` is the B-field value ($\mu$T) on y-axis at the position of the outside sensor generated by the Forwar-backward coil when applying current `I=1A`.

- Read from ADC:
```
def read_aio(aio, channel_id):
    return aio.analog_read_volt(channel_id, aio.DataRate.DR_860SPS)

def read_aio_all(aio):
    ret = []
    for channel in range(32):
        ret.append(read_aio(aio,channel))
    return ret
```
Will return a list for ADC readout.

- Safety check (**Can be modified under different requirement.** ):
```
def check_safety(deltaBx,deltaBy,deltaBz,T1,T2,Ix,Iy,Iz):
    ret = True
    print('------Safety check------')
    print('Temperature:')
    print('T1 = ',T1,"degree")
    print('T2 = ',T2,"degree")

    print('Expected compensation B field at the center:')
    print('deltaBx = ',deltaBx,"muT")
    print('deltaBy = ',deltaBy,"muT")
    print('deltaBz = ',deltaBz,"muT")

    print('Needed current:')
    print('deltaIx(I_LR) = ',Ix,"A")
    print('deltaIy(I_UD) = ',Iy,"A")
    print('deltaIz(I_FB) = ',Iz,"A")

    #Current check
    if Ix > 5. or Iy > 5. or Iz > 5.:
        ret = False
        print("Needed current too large! Safety check failed.")


    #Temperature check
    if T1 > 30. or T2 > 30.:
        ret = False
        print("Temperature too high! Safety check failed.")

    #Probe signal check 
    Bx = abs(deltaBx)
    By = abs(deltaBy)
    Bz = abs(deltaBz)
    if Bx > 100 or By > 100 or Bz > 100:
        ret = False
        print("Detected magnetic field too large! Safety check failed.")

    if ret == True:
        print('Safety check is passed.')
    print('------------------------')
    return ret

```
When the needed current larger than 5A, temperature is higher than 30 deg., the needed compensate B-field larger than 100$\muT$, the safety check will be failed.

- Convert voltage readout to B-field value:
```
def get_sensorB(ADCreadout):
    #need to be modified when upgrading probes!!!
    #Vx -> By, Vy -> -Bx, Vz -> Bz

    Fx = -1*35*(ADCreadout[chVy])
    Fy = 35*(ADCreadout[chVx])
    Fz = 35*(ADCreadout[chVz])

    return (Fx, Fy, Fz)
```

- Calculating the needed compensate B-field at center and the needed changing current using the previou difined matrix and the current applied coil current:
```
def get_deltaB(Fx, Fy, Fz, Ixnow, Iynow, Iznow):
    #need to be modified when upgrading probes!!!

    Inow = np.mat([Ixnow, Iynow, Iznow]).T
    F0out = np.mat([Fx, Fy, Fz]).T - np.dot(matOut,Inow)

    Fcen = np.dot(matCen,Inow) + F0out + const_Bcen - const_Bout

    deltaBx = Fcen[0,0]
    deltaBy = Fcen[1,0]
    deltaBz = Fcen[2,0]

    return (deltaBx, deltaBy, deltaBz)

def cal_deltaI(deltaBx,deltaBy,deltaBz):
    #need to be modified when selecting different compensation coordinate!!!
    #initial: Bx0 ~ , By0 ~ , Bz0 ~ 

    deltaB = -1*np.mat([deltaBx,deltaBy,deltaBz]).T

    deltaI = np.dot(invmatCen,deltaB)

    deltaIx = deltaI[0,0]
    deltaIy = deltaI[1,0]
    deltaIz = deltaI[2,0]

    return (deltaIx,deltaIy,deltaIz)
```

- Main function of the macro. It is an infinite loop util safety check is failed or stopped by KeyboardInterrupt.

Read from ADC -> Read from power supply -> Convert ADC readout to B-field values -> Calculate needed compensation B-field -> Calculate needed changing of the applied currents for coils -> Safety check -> Changing currents for coils -> System sleep and back to the loop
```
        while True:

            #ADC readout, minimum readout for current used AIO-32/0RA-IRC is 0.000306259 V
            aio = aio320ra.AIO_32_0RA_IRC(0x49, 0x3e)
            ADCreadout = read_aio_all(aio)
    
            #current values for power supply
            Ixnow = comm.ReadCurrent()[1]
            Iynow = comm2.ReadCurrent()[1]
            Iznow = comm3.ReadCurrent()[1]

            Fx, Fy, Fz = get_sensorB(ADCreadout)

            deltaBx, deltaBy, deltaBz = get_deltaB(Fx, Fy, Fz, Ixnow, Iynow, Iznow)

            deltaIx, deltaIy, deltaIz = cal_deltaI(deltaBx,deltaBy,deltaBz)

            Ix = Ixnow + deltaIx
            Iy = Iynow + deltaIy
            Iz = Iznow + deltaIz

            if check_safety(deltaBx,deltaBy,deltaBz,Ix,Iy,Iz) == False:
                triggerPrint = True
                break

            comm.SetCurrent(Iy)
            comm2.SetCurrent(Ix)
            comm3.SetCurrent(Iz)


            #compensation frequency/time-interval!!!
            time.sleep(deltaT)

```

